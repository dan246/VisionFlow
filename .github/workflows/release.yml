name: VisionFlow Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================
  # å»ºç«‹ Release
  # ==========================================
  create-release:
    name: å»ºç«‹ Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ç”¢ç”Ÿæ›´æ–°æ—¥èªŒ
      id: changelog
      run: |
        # å¾ git log ç”¢ç”Ÿæ›´æ–°æ—¥èªŒ
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: å»ºç«‹ Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: VisionFlow ${{ github.ref }}
        body: |
          ## ğŸ¯ VisionFlow ${{ github.ref }}
          
          ### ğŸ“‹ æ›´æ–°å…§å®¹
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ### ğŸš€ éƒ¨ç½²æ–¹å¼
          ```bash
          # ä¸‹è¼‰ä¸¦é‹è¡Œ
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/docker-compose.yml
          docker-compose up -d
          ```
          
          ### ğŸ“Š æ˜ åƒæ¨™ç±¤
          - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:${{ github.ref }}`
          - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/camera-ctrl:${{ github.ref }}`
          - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/object-recognition:${{ github.ref }}`
          - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/redis-worker:${{ github.ref }}`
        draft: false
        prerelease: false

  # ==========================================
  # æ§‹å»ºä¸¦æ¨é€ Release æ˜ åƒ
  # ==========================================
  build-release-images:
    name: æ§‹å»º Release æ˜ åƒ
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        service: 
          - name: web
            dockerfile: Dockerfile
            context: web
          - name: camera-ctrl
            dockerfile: cameractrlDockerfile
            context: camera_ctrler
          - name: object-recognition
            dockerfile: objectrecognitionDockerfile
            context: object_recognition
          - name: redis-worker
            dockerfile: rtsptestDockerfile
            context: redisv1

    permissions:
      contents: read
      packages: write

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å…¥ Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–ç‰ˆæœ¬è™Ÿ
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: æ§‹å»ºä¸¦æ¨é€ Release æ˜ åƒ
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service.context }}
        file: ${{ matrix.service.context }}/${{ matrix.service.dockerfile }}
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service.name }}:${{ steps.get_version.outputs.VERSION }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service.name }}:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ==========================================
  # æº–å‚™ Release æª”æ¡ˆ
  # ==========================================
  prepare-release-assets:
    name: æº–å‚™ Release æª”æ¡ˆ
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: æå–ç‰ˆæœ¬è™Ÿ
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: æº–å‚™ docker-compose æª”æ¡ˆ
      run: |
        # æ›´æ–° docker-compose.yml ä¸­çš„æ˜ åƒæ¨™ç±¤
        sed -i.bak "s|build:|#build:|g" docker-compose.yaml
        sed -i.bak "s|context: \./web|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:${{ steps.get_version.outputs.VERSION }}|g" docker-compose.yaml
        sed -i.bak "s|dockerfile: Dockerfile|#dockerfile: Dockerfile|g" docker-compose.yaml
        
        # å»ºç«‹éƒ¨ç½²èªªæ˜
        cat > DEPLOY_INSTRUCTIONS.md << EOF
        # VisionFlow ${{ steps.get_version.outputs.VERSION }} éƒ¨ç½²èªªæ˜
        
        ## å¿«é€Ÿéƒ¨ç½²
        \`\`\`bash
        # 1. ä¸‹è¼‰ docker-compose.yml
        wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/docker-compose.yml
        
        # 2. å»ºç«‹ç’°å¢ƒæª”æ¡ˆ
        cp .env.example .env
        # ç·¨è¼¯ .env æª”æ¡ˆè¨­å®šæ‚¨çš„ç’°å¢ƒè®Šæ•¸
        
        # 3. å•Ÿå‹•æœå‹™
        docker-compose up -d
        
        # 4. æª¢æŸ¥æœå‹™ç‹€æ…‹
        docker-compose ps
        \`\`\`
        
        ## æœå‹™å­˜å–
        - Web ä»‹é¢: http://localhost:5000
        - API æ–‡ä»¶: http://localhost:5000/docs
        - ç›£æ§é¢æ¿: http://localhost:5000/monitor
        
        ## æ•…éšœæ’é™¤
        æª¢è¦–æ—¥èªŒï¼š
        \`\`\`bash
        docker-compose logs -f [service_name]
        \`\`\`
        EOF

    - name: ä¸Šå‚³ docker-compose.yml
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./docker-compose.yaml
        asset_name: docker-compose.yml
        asset_content_type: application/x-yaml

    - name: ä¸Šå‚³ç’°å¢ƒæª”æ¡ˆç¯„ä¾‹
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./.env.example
        asset_name: .env.example
        asset_content_type: text/plain

    - name: ä¸Šå‚³éƒ¨ç½²èªªæ˜
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./DEPLOY_INSTRUCTIONS.md
        asset_name: DEPLOY_INSTRUCTIONS.md
        asset_content_type: text/markdown

  # ==========================================
  # é€šçŸ¥
  # ==========================================
  notify-release:
    name: Release é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-release-images, prepare-release-assets]

    steps:
    - name: æå–ç‰ˆæœ¬è™Ÿ
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: ç™¼é€ Release é€šçŸ¥
      run: |
        echo "ğŸ‰ VisionFlow ${{ steps.get_version.outputs.VERSION }} å·²æˆåŠŸç™¼å¸ƒï¼"
        echo "ğŸ“¦ æ‰€æœ‰æ˜ åƒå·²æ¨é€åˆ° Container Registry"
        echo "ğŸ“„ Release æª”æ¡ˆå·²æº–å‚™å®Œæˆ"
        # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„é€šçŸ¥é‚è¼¯
