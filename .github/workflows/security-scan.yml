name: VisionFlow Security & Quality Check

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯é€±ä¸€å‡Œæ™¨ 2 é»é‹è¡Œ
  workflow_dispatch:

jobs:
  # ==========================================
  # ä¾è³´æ€§å®‰å…¨æƒæ
  # ==========================================
  dependency-security:
    name: ä¾è³´æ€§å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ["web", "object_recognition", "camera_ctrler", "redisv1"]

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£ safety
      run: pip install safety

    - name: æƒæä¾è³´æ€§æ¼æ´
      run: |
        if [ -f ${{ matrix.service }}/requirements.txt ]; then
          safety check -r ${{ matrix.service }}/requirements.txt --json > ${{ matrix.service }}-safety-report.json || true
        fi

    - name: ä¸Šå‚³å®‰å…¨å ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: "*-safety-report.json"
        retention-days: 7

  # ==========================================
  # ç¨‹å¼ç¢¼å“è³ªåˆ†æ
  # ==========================================
  code-quality:
    name: ç¨‹å¼ç¢¼å“è³ªåˆ†æ
    runs-on: ubuntu-latest

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥..."
        
        # å®‰è£æª¢æŸ¥å·¥å…·
        pip install flake8 bandit pycodestyle
        
        # æª¢æŸ¥ Python ç¨‹å¼ç¢¼å“è³ª
        for service in web object_recognition camera_ctrler redisv1; do
          if [ -d "$service" ]; then
            echo "æª¢æŸ¥ $service æœå‹™..."
            
            # Flake8 èªæ³•æª¢æŸ¥
            flake8 $service --max-line-length=88 --ignore=E203,W503 --format=json > $service-flake8.json || true
            
            # Bandit å®‰å…¨æª¢æŸ¥
            bandit -r $service -f json -o $service-bandit.json || true
          fi
        done

    - name: ä¸Šå‚³å“è³ªå ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-reports
        path: "*-flake8.json"
        retention-days: 7

    - name: SonarCloud æƒæ (å¯é¸)
      continue-on-error: true
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # æˆæ¬Šåˆè¦æª¢æŸ¥
  # ==========================================
  license-check:
    name: æˆæ¬Šåˆè¦æª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£ pip-licenses
      run: pip install pip-licenses

    - name: æª¢æŸ¥æˆæ¬Š
      run: |
        for service in web object_recognition camera_ctrler redisv1; do
          if [ -f $service/requirements.txt ]; then
            pip install -r $service/requirements.txt || continue
            pip-licenses --format=json --output-file=$service-licenses.json || true
          fi
        done

    - name: ä¸Šå‚³æˆæ¬Šå ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: license-reports
        path: "*-licenses.json"
        retention-days: 7
