/**
 * VisionFlow Real-time Monitoring Dashboard
 * Advanced WebSocket-based dashboard with modern UI/UX
 */

class VisionFlowAdvancedDashboard {
    constructor() {
        this.socket = null;
        this.charts = {};
        this.isConnected = false;
        this.retryCount = 0;
        this.maxRetries = 5;
        this.updateInterval = null;
        this.notifications = [];
        
        this.init();
    }

    async init() {
        this.showLoadingScreen();
        await this.initializeSocket();
        this.initializeCharts();
        this.initializeUI();
        this.setupEventListeners();
        this.startPeriodicUpdates();
        this.hideLoadingScreen();
    }

    showLoadingScreen() {
        const loadingHTML = `
            <div id="loading-screen" class="loading-screen">
                <div class="loading-content">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <h4 class="mt-3">Ê≠£Âú®ÂàùÂßãÂåñ VisionFlow Á≥ªÁµ±</h4>
                    <p class="text-muted">Ê≠£Âú®ÈÄ£Êé•Áõ£ÊéßÊúçÂãô...</p>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('afterbegin', loadingHTML);
    }

    hideLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.remove(), 500);
        }
    }

    async initializeSocket() {
        try {
            this.socket = io({
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true,
                reconnection: true,
                reconnectionAttempts: this.maxRetries,
                reconnectionDelay: 1000,
                timeout: 5000
            });

            this.socket.on('connect', () => {
                console.log('‚úÖ VisionFlow ÈÄ£Êé•ÊàêÂäü');
                this.isConnected = true;
                this.retryCount = 0;
                this.showNotification('Á≥ªÁµ±ÈÄ£Êé•ÊàêÂäü', 'success');
                this.socket.emit('join_room', { room: 'dashboard' });
            });

            this.socket.on('disconnect', () => {
                console.log('‚ùå VisionFlow ÈÄ£Êé•Êñ∑Èñã');
                this.isConnected = false;
                this.showNotification('ÈÄ£Êé•Â∑≤Êñ∑ÈñãÔºåÊ≠£Âú®ÈáçÊñ∞ÈÄ£Êé•...', 'warning');
            });

            this.socket.on('reconnect', () => {
                console.log('üîÑ VisionFlow ÈáçÊñ∞ÈÄ£Êé•ÊàêÂäü');
                this.showNotification('ÈáçÊñ∞ÈÄ£Êé•ÊàêÂäü', 'success');
            });

            // ÂØ¶ÊôÇÊï∏ÊìöÁõ£ËÅΩ
            this.socket.on('detection_update', (data) => {
                this.handleDetectionUpdate(data);
            });

            this.socket.on('alert_update', (data) => {
                this.handleAlertUpdate(data);
            });

            this.socket.on('system_status', (data) => {
                this.handleSystemStatusUpdate(data);
            });

            this.socket.on('camera_status', (data) => {
                this.handleCameraStatusUpdate(data);
            });

        } catch (error) {
            console.error('Socket ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            this.showNotification('ÈÄ£Êé•ÂàùÂßãÂåñÂ§±Êïó', 'error');
        }
    }

    initializeCharts() {
        // ÂàùÂßãÂåñÊ™¢Ê∏¨Ë∂®Âã¢ÂúñË°®
        this.initDetectionTrendChart();
        
        // ÂàùÂßãÂåñÊ™¢Ê∏¨È°ûÂûãÂàÜÂ∏ÉÂúñ
        this.initDetectionTypeChart();
        
        // ÂàùÂßãÂåñÁ≥ªÁµ±ÊïàËÉΩÂúñË°®
        this.initSystemPerformanceChart();
        
        // ÂàùÂßãÂåñÊîùÂΩ±Ê©üÁãÄÊÖãÂúñË°®
        this.initCameraStatusChart();
    }

    initDetectionTrendChart() {
        const ctx = document.getElementById('detectionTrendChart')?.getContext('2d');
        if (!ctx) return;

        this.charts.detectionTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Ê™¢Ê∏¨Êï∏Èáè',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Ë≠¶Â†±Êï∏Èáè',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Ê™¢Ê∏¨ËàáË≠¶Â†±Ë∂®Âã¢ (ÈÅéÂéª24Â∞èÊôÇ)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    initDetectionTypeChart() {
        const ctx = document.getElementById('detectionTypeChart')?.getContext('2d');
        if (!ctx) return;

        this.charts.detectionType = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‰∫∫Âì°', 'ËªäËºõ', 'ÂãïÁâ©', 'ÂåÖË£π', 'ÂÖ∂‰ªñ'],
                datasets: [{
                    data: [45, 25, 15, 10, 5],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    title: {
                        display: true,
                        text: 'Ê™¢Ê∏¨È°ûÂûãÂàÜÂ∏É'
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 1000
                }
            }
        });
    }

    initSystemPerformanceChart() {
        const ctx = document.getElementById('systemPerformanceChart')?.getContext('2d');
        if (!ctx) return;

        this.charts.systemPerformance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['CPU‰ΩøÁî®Áéá', 'Ë®òÊÜ∂È´î‰ΩøÁî®Áéá', 'Á£ÅÁ¢ü‰ΩøÁî®Áéá', 'Á∂≤Ë∑ØIO', 'ËôïÁêÜ‰ΩáÂàó', 'FPSÂπ≥Âùá'],
                datasets: [{
                    label: 'Á≥ªÁµ±ÊïàËÉΩ',
                    data: [65, 70, 45, 80, 20, 95],
                    borderColor: 'rgb(255, 206, 86)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    pointBackgroundColor: 'rgb(255, 206, 86)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(255, 206, 86)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Á≥ªÁµ±ÊïàËÉΩÁõ£Êéß'
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        angleLines: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    initCameraStatusChart() {
        const ctx = document.getElementById('cameraStatusChart')?.getContext('2d');
        if (!ctx) return;

        this.charts.cameraStatus = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '‰ªäÊó•Ê™¢Ê∏¨Êï∏Èáè',
                    data: [],
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        if (value > 80) return '#28a745';
                        if (value > 50) return '#ffc107';
                        return '#dc3545';
                    },
                    borderRadius: 5,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'ÊîùÂΩ±Ê©üÊ™¢Ê∏¨Áµ±Ë®à'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    initializeUI() {
        // ÂàùÂßãÂåñÊ®ôÁ±§È†ÅÂàáÊèõ
        this.initTabSwitching();
        
        // ÂàùÂßãÂåñÈÄöÁü•Á≥ªÁµ±
        this.initNotificationSystem();
        
        // ÂàùÂßãÂåñÊîùÂΩ±Ê©üÁ∂≤Ê†º
        this.initCameraGrid();
        
        // ÂàùÂßãÂåñË®≠ÂÆöÈù¢Êùø
        this.initSettingsPanel();
    }

    initTabSwitching() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                
                // ÁßªÈô§ÊâÄÊúâÊ¥ªÂãïÁãÄÊÖã
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));
                
                // Ê∑ªÂä†Áï∂ÂâçÊ®ôÁ±§ÁöÑÊ¥ªÂãïÁãÄÊÖã
                button.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                // Â¶ÇÊûúÂàáÊèõÂà∞ÂúñË°®Ê®ôÁ±§ÔºåÈáçÊñ∞Ë™øÊï¥ÂúñË°®Â§ßÂ∞è
                if (targetTab === 'dashboard') {
                    setTimeout(() => {
                        Object.values(this.charts).forEach(chart => {
                            if (chart && chart.resize) {
                                chart.resize();
                            }
                        });
                    }, 100);
                }
            });
        });
    }

    initNotificationSystem() {
        // ÂâµÂª∫ÈÄöÁü•ÂÆπÂô®
        if (!document.getElementById('notification-container')) {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.className = 'notification-container';
            document.body.appendChild(container);
        }
    }

    initCameraGrid() {
        const cameraGrid = document.getElementById('camera-grid');
        if (cameraGrid) {
            this.loadCameraData();
        }
    }

    initSettingsPanel() {
        // ÂàùÂßãÂåñË®≠ÂÆöÈù¢ÊùøÁöÑÂêÑÁ®ÆÊéßÂà∂È†Ö
        this.initThemeToggle();
        this.initNotificationSettings();
        this.initSystemSettings();
    }

    initThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('change', (e) => {
                const theme = e.target.checked ? 'dark' : 'light';
                this.setTheme(theme);
            });
        }
    }

    setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('visionflow-theme', theme);
    }

    setupEventListeners() {
        // Á™óÂè£Â§ßÂ∞èËÆäÂåñÊôÇÈáçÊñ∞Ë™øÊï¥ÂúñË°®
        window.addEventListener('resize', () => {
            setTimeout(() => {
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.resize) {
                        chart.resize();
                    }
                });
            }, 100);
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñËôïÁêÜ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.pauseUpdates();
            } else {
                this.resumeUpdates();
            }
        });
    }

    startPeriodicUpdates() {
        this.updateInterval = setInterval(() => {
            if (this.isConnected) {
                this.fetchLatestData();
            }
        }, 5000); // ÊØè5ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
    }

    pauseUpdates() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }

    resumeUpdates() {
        if (!this.updateInterval) {
            this.startPeriodicUpdates();
        }
    }

    async fetchLatestData() {
        try {
            const [analytics, alerts, cameras, performance] = await Promise.all([
                fetch('/api/analytics/summary').then(r => r.json()),
                fetch('/api/alerts/active').then(r => r.json()),
                fetch('/api/cameras/status').then(r => r.json()),
                fetch('/api/system/performance').then(r => r.json())
            ]);

            this.updateDashboardStats(analytics);
            this.updateAlertsDisplay(alerts);
            this.updateCamerasDisplay(cameras);
            this.updateSystemPerformance(performance);

        } catch (error) {
            console.error('Áç≤ÂèñÊï∏ÊìöÂ§±Êïó:', error);
            this.showNotification('Êï∏ÊìöÊõ¥Êñ∞Â§±Êïó', 'error');
        }
    }

    updateDashboardStats(data) {
        // Êõ¥Êñ∞Áµ±Ë®àÂç°Áâá
        this.updateStatCard('total-detections', data.total_detections);
        this.updateStatCard('active-cameras', data.active_cameras);
        this.updateStatCard('alerts-today', data.alerts_today);
        this.updateStatCard('system-uptime', data.system_uptime);
    }

    updateStatCard(id, value) {
        const element = document.getElementById(id);
        if (element) {
            const oldValue = element.textContent;
            if (oldValue !== value.toString()) {
                element.style.transform = 'scale(1.1)';
                element.textContent = value;
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 200);
            }
        }
    }

    handleDetectionUpdate(data) {
        // ËôïÁêÜÂØ¶ÊôÇÊ™¢Ê∏¨Êõ¥Êñ∞
        this.updateDetectionTrendChart(data);
        this.showNotification(`Êñ∞Ê™¢Ê∏¨: ${data.type} Âú® ${data.camera_id}`, 'info');
    }

    handleAlertUpdate(data) {
        // ËôïÁêÜË≠¶Â†±Êõ¥Êñ∞
        this.showNotification(`‚ö†Ô∏è ${data.type}: ${data.description}`, 'warning');
        this.updateAlertsCount();
    }

    handleSystemStatusUpdate(data) {
        // ËôïÁêÜÁ≥ªÁµ±ÁãÄÊÖãÊõ¥Êñ∞
        this.updateSystemPerformanceChart(data);
    }

    handleCameraStatusUpdate(data) {
        // ËôïÁêÜÊîùÂΩ±Ê©üÁãÄÊÖãÊõ¥Êñ∞
        this.updateCameraGrid(data);
    }

    showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        if (!container) return;

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-message">${message}</span>
                <button class="notification-close">&times;</button>
            </div>
        `;

        container.appendChild(notification);

        // Ê∑ªÂä†ÈóúÈñâ‰∫ã‰ª∂
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            this.removeNotification(notification);
        });

        // Ëá™ÂãïÁßªÈô§
        setTimeout(() => {
            this.removeNotification(notification);
        }, 5000);

        // Ê∑ªÂä†ÂãïÁï´
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
    }

    removeNotification(notification) {
        notification.classList.add('hide');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }

    async loadCameraData() {
        try {
            const response = await fetch('/api/cameras/status');
            const data = await response.json();
            this.updateCameraGrid(data.cameras);
        } catch (error) {
            console.error('ËºâÂÖ•ÊîùÂΩ±Ê©üÊï∏ÊìöÂ§±Êïó:', error);
            this.showNotification('ÊîùÂΩ±Ê©üÊï∏ÊìöËºâÂÖ•Â§±Êïó', 'error');
        }
    }

    updateCameraGrid(cameras) {
        const grid = document.getElementById('camera-grid');
        if (!grid || !cameras) return;

        grid.innerHTML = cameras.map(camera => `
            <div class="camera-card ${camera.status}" data-camera-id="${camera.id}">
                <div class="camera-header">
                    <h6>${camera.name}</h6>
                    <span class="status-indicator ${camera.status}"></span>
                </div>
                <div class="camera-preview">
                    <img src="${camera.stream_url}" alt="${camera.name}" 
                         onerror="this.src='/static/images/camera-placeholder.png'">
                </div>
                <div class="camera-info">
                    <small>‰ΩçÁΩÆ: ${camera.location}</small>
                    <small>‰ªäÊó•Ê™¢Ê∏¨: ${camera.detection_count_today}</small>
                </div>
            </div>
        `).join('');
    }

    destroy() {
        // Ê∏ÖÁêÜË≥áÊ∫ê
        if (this.socket) {
            this.socket.disconnect();
        }
        
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
        }
        
        Object.values(this.charts).forEach(chart => {
            if (chart && chart.destroy) {
                chart.destroy();
            }
        });
    }
}

// ÂàùÂßãÂåñÂÑÄË°®Êùø
document.addEventListener('DOMContentLoaded', () => {
    window.visionFlowDashboard = new VisionFlowAdvancedDashboard();
});

// Ê∏ÖÁêÜË≥áÊ∫ê
window.addEventListener('beforeunload', () => {
    if (window.visionFlowDashboard) {
        window.visionFlowDashboard.destroy();
    }
});
