<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç³»çµ±æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”” é€šçŸ¥ç³»çµ±æ¸¬è©¦é é¢</h1>
        
        <div class="status" id="status">
            æ­£åœ¨è¼‰å…¥é€šçŸ¥ç³»çµ±...
        </div>
        
        <div id="controls" style="display: none;">
            <h3>åŠŸèƒ½æ¸¬è©¦</h3>
            <button class="btn" onclick="testBasicNotification()">æ¸¬è©¦åŸºæœ¬é€šçŸ¥</button>
            <button class="btn" onclick="testSuccessNotification()">æ¸¬è©¦æˆåŠŸé€šçŸ¥</button>
            <button class="btn" onclick="testErrorNotification()">æ¸¬è©¦éŒ¯èª¤é€šçŸ¥</button>
            <button class="btn" onclick="testInfoNotification()">æ¸¬è©¦è³‡è¨Šé€šçŸ¥</button>
            <button class="btn" onclick="testWarningNotification()">æ¸¬è©¦è­¦å‘Šé€šçŸ¥</button>
            <button class="btn" onclick="testAPICall()">æ¸¬è©¦ API èª¿ç”¨</button>
            <button class="btn" onclick="testStatistics()">æ¸¬è©¦çµ±è¨ˆè³‡æ–™</button>
            
            <h3>ç³»çµ±ç‹€æ…‹</h3>
            <div id="systemInfo"></div>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- è¼‰å…¥é€šçŸ¥ç³»çµ± -->
    <script src="/static/js/smart-notifications.js"></script>
    
    <script>
        let notificationSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await waitForNotificationSystem();
                document.getElementById('status').innerHTML = 'âœ… é€šçŸ¥ç³»çµ±å·²å°±ç·’ï¼';
                document.getElementById('controls').style.display = 'block';
                updateSystemInfo();
            } catch (error) {
                document.getElementById('status').innerHTML = 'âŒ é€šçŸ¥ç³»çµ±è¼‰å…¥å¤±æ•—: ' + error.message;
                console.error('è¼‰å…¥å¤±æ•—:', error);
            }
        });

        async function waitForNotificationSystem() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkSystem = () => {
                    attempts++;
                    console.log(`æª¢æŸ¥é€šçŸ¥ç³»çµ± (å˜—è©¦ ${attempts}/${maxAttempts})`);
                    
                    if (window.smartNotifications) {
                        notificationSystem = window.smartNotifications;
                        console.log('ä½¿ç”¨ç¾æœ‰å¯¦ä¾‹');
                        resolve();
                    } else if (window.SmartNotificationSystem) {
                        try {
                            notificationSystem = new SmartNotificationSystem();
                            console.log('å‰µå»ºæ–°å¯¦ä¾‹');
                            setTimeout(resolve, 2000);
                        } catch (error) {
                            console.error('å‰µå»ºå¯¦ä¾‹å¤±æ•—:', error);
                            if (attempts < maxAttempts) {
                                setTimeout(checkSystem, 100);
                            } else {
                                reject(new Error('ç„¡æ³•å‰µå»ºå¯¦ä¾‹'));
                            }
                        }
                    } else if (attempts < maxAttempts) {
                        setTimeout(checkSystem, 100);
                    } else {
                        reject(new Error('ç„¡æ³•è¼‰å…¥é€šçŸ¥ç³»çµ±'));
                    }
                };
                checkSystem();
            });
        }

        function testBasicNotification() {
            try {
                notificationSystem.show({
                    title: 'åŸºæœ¬é€šçŸ¥æ¸¬è©¦',
                    message: 'é€™æ˜¯ä¸€å€‹åŸºæœ¬çš„é€šçŸ¥æ¸¬è©¦',
                    type: 'info'
                });
                updateStatus('âœ… åŸºæœ¬é€šçŸ¥å·²ç™¼é€');
            } catch (error) {
                updateStatus('âŒ åŸºæœ¬é€šçŸ¥å¤±æ•—: ' + error.message);
            }
        }

        function testSuccessNotification() {
            try {
                notificationSystem.success('æˆåŠŸé€šçŸ¥', 'é€™æ˜¯ä¸€å€‹æˆåŠŸé€šçŸ¥çš„æ¸¬è©¦');
                updateStatus('âœ… æˆåŠŸé€šçŸ¥å·²ç™¼é€');
            } catch (error) {
                updateStatus('âŒ æˆåŠŸé€šçŸ¥å¤±æ•—: ' + error.message);
            }
        }

        function testErrorNotification() {
            try {
                notificationSystem.error('éŒ¯èª¤é€šçŸ¥', 'é€™æ˜¯ä¸€å€‹éŒ¯èª¤é€šçŸ¥çš„æ¸¬è©¦');
                updateStatus('âœ… éŒ¯èª¤é€šçŸ¥å·²ç™¼é€');
            } catch (error) {
                updateStatus('âŒ éŒ¯èª¤é€šçŸ¥å¤±æ•—: ' + error.message);
            }
        }

        function testInfoNotification() {
            try {
                notificationSystem.info('è³‡è¨Šé€šçŸ¥', 'é€™æ˜¯ä¸€å€‹è³‡è¨Šé€šçŸ¥çš„æ¸¬è©¦');
                updateStatus('âœ… è³‡è¨Šé€šçŸ¥å·²ç™¼é€');
            } catch (error) {
                updateStatus('âŒ è³‡è¨Šé€šçŸ¥å¤±æ•—: ' + error.message);
            }
        }

        function testWarningNotification() {
            try {
                notificationSystem.warning('è­¦å‘Šé€šçŸ¥', 'é€™æ˜¯ä¸€å€‹è­¦å‘Šé€šçŸ¥çš„æ¸¬è©¦');
                updateStatus('âœ… è­¦å‘Šé€šçŸ¥å·²ç™¼é€');
            } catch (error) {
                updateStatus('âŒ è­¦å‘Šé€šçŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function testAPICall() {
            try {
                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        channel: 'desktop',
                        title: 'API æ¸¬è©¦',
                        message: 'é€™æ˜¯é€é API ç™¼é€çš„æ¸¬è©¦é€šçŸ¥'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateStatus('âœ… API æ¸¬è©¦æˆåŠŸ: ' + result.data.message);
                } else {
                    updateStatus('âŒ API æ¸¬è©¦å¤±æ•—');
                }
            } catch (error) {
                updateStatus('âŒ API èª¿ç”¨å¤±æ•—: ' + error.message);
            }
        }

        async function testStatistics() {
            try {
                const stats = await notificationSystem.getStatistics();
                updateStatus('âœ… çµ±è¨ˆè³‡æ–™è¼‰å…¥æˆåŠŸ: ' + JSON.stringify(stats).substring(0, 100) + '...');
            } catch (error) {
                updateStatus('âŒ çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—: ' + error.message);
            }
        }

        function updateStatus(message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('status').innerHTML = `[${timestamp}] ${message}`;
        }

        function updateSystemInfo() {
            const info = {
                'é€šçŸ¥ç³»çµ±å¯¦ä¾‹': notificationSystem ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥',
                'æ”¯æ´çš„æ–¹æ³•': notificationSystem ? Object.getOwnPropertyNames(Object.getPrototypeOf(notificationSystem)).join(', ') : 'ç„¡',
                'ç•¶å‰è¨­å®š': notificationSystem ? JSON.stringify(notificationSystem.settings || {}).substring(0, 100) + '...' : 'ç„¡',
                'ç•¶å‰é€šé“': notificationSystem ? JSON.stringify(notificationSystem.channels || {}) : 'ç„¡'
            };
            
            document.getElementById('systemInfo').innerHTML = Object.entries(info)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
        }
    </script>
</body>
</html>
