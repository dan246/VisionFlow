<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionFlow - æ™ºèƒ½é€šçŸ¥è¨­å®š</title>
    
    <!-- Meta tags for PWA -->
    <meta name="description" content="VisionFlow æ™ºèƒ½é€šçŸ¥ç³»çµ±è¨­å®š - å€‹äººåŒ–é€šçŸ¥åå¥½èˆ‡å¤šé€šé“ç®¡ç†">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="VisionFlow Notifications">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/static/images/apple-touch-icon.png">
    
    <!-- External Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link href="/static/css/smart-notifications.css" rel="stylesheet">
    
    <style>
        /* Notifications Settings Specific Styles */
        .settings-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
            font-family: 'Inter', sans-serif;
        }

        .settings-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .settings-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .settings-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .settings-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin: 0;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .settings-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: white;
            font-weight: 500;
        }

        .setting-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .setting-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            width: 120px;
        }

        .setting-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.25rem;
            display: inline-block;
        }

        .priority-critical {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .priority-high {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 1px solid #ffa502;
        }

        .priority-medium {
            background: rgba(55, 66, 250, 0.2);
            color: #3742fa;
            border: 1px solid #3742fa;
        }

        .priority-low {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid #2ed573;
        }

        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: white;
        }

        .stats-overview {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .toggle-switch .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .settings-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="settings-dashboard">
        <div class="settings-container">
            <!-- Header Section -->
            <div class="settings-header">
                <h1 class="settings-title">
                    <i class="fas fa-bell"></i>
                    æ™ºèƒ½é€šçŸ¥è¨­å®š
                </h1>
                <p class="settings-subtitle">
                    å€‹äººåŒ–æ‚¨çš„é€šçŸ¥åå¥½ï¼Œæ‰“é€ æœ€é©åˆçš„ç›£æ§é«”é©—
                </p>
            </div>

            <!-- Settings Grid -->
            <div class="settings-grid">
                <!-- çµ±è¨ˆæ¦‚è¦½ -->
                <div class="settings-card stats-overview">
                    <div class="stat-item">
                        <div class="stat-number" id="totalNotifications">256</div>
                        <div class="stat-label">ç¸½é€šçŸ¥æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="todayNotifications">18</div>
                        <div class="stat-label">ä»Šæ—¥é€šçŸ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="readNotifications">242</div>
                        <div class="stat-label">å·²è®€é€šçŸ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgResponseTime">2.3</div>
                        <div class="stat-label">å¹³å‡å›æ‡‰æ™‚é–“(åˆ†)</div>
                    </div>
                </div>

                <!-- é€šçŸ¥é€šé“è¨­å®š -->
                <div class="settings-card">
                    <h3 class="card-title">
                        <i class="fas fa-broadcast-tower"></i>
                        é€šçŸ¥é€šé“
                    </h3>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ¡Œé¢é€šçŸ¥</div>
                            <div class="setting-description">åœ¨ç€è¦½å™¨ä¸­é¡¯ç¤ºé€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="desktopNotifications">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">è²éŸ³æé†’</div>
                            <div class="setting-description">æ’­æ”¾é€šçŸ¥éŸ³æ•ˆ</div>
                        </div>
                        <div class="toggle-switch" id="soundNotifications">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">éœ‡å‹•æé†’</div>
                            <div class="setting-description">æ‰‹æ©Ÿéœ‡å‹•é€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="vibrationNotifications">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">éƒµä»¶é€šçŸ¥</div>
                            <div class="setting-description">ç™¼é€é›»å­éƒµä»¶</div>
                        </div>
                        <div class="toggle-switch" id="emailNotifications">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">LINE é€šçŸ¥</div>
                            <div class="setting-description">LINE è¨Šæ¯æ¨é€</div>
                        </div>
                        <div class="toggle-switch" id="lineNotifications">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <!-- é€šçŸ¥åå¥½è¨­å®š -->
                <div class="settings-card">
                    <h3 class="card-title">
                        <i class="fas fa-sliders-h"></i>
                        é€šçŸ¥åå¥½
                    </h3>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">é€šçŸ¥é¡¯ç¤ºæ™‚é–“</div>
                            <div class="setting-description">ç§’</div>
                        </div>
                        <input type="number" class="setting-input" id="displayDuration" value="5" min="1" max="30">
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æœ€å¤§é€šçŸ¥æ•¸é‡</div>
                            <div class="setting-description">åŒæ™‚é¡¯ç¤ºçš„æœ€å¤§æ•¸é‡</div>
                        </div>
                        <input type="number" class="setting-input" id="maxNotifications" value="5" min="1" max="10">
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">é€šçŸ¥ä½ç½®</div>
                            <div class="setting-description">è¢å¹•é¡¯ç¤ºä½ç½®</div>
                        </div>
                        <select class="setting-input" id="notificationPosition">
                            <option value="top-right">å³ä¸Šè§’</option>
                            <option value="top-left">å·¦ä¸Šè§’</option>
                            <option value="bottom-right">å³ä¸‹è§’</option>
                            <option value="bottom-left">å·¦ä¸‹è§’</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ‰¹é‡è™•ç†</div>
                            <div class="setting-description">åˆä½µç›¸ä¼¼é€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="batchNotifications">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ™ºèƒ½åˆ†çµ„</div>
                            <div class="setting-description">è‡ªå‹•åˆ†çµ„ç›¸é—œé€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="smartGrouping">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <!-- å„ªå…ˆç´šè¨­å®š -->
                <div class="settings-card">
                    <h3 class="card-title">
                        <i class="fas fa-flag"></i>
                        å„ªå…ˆç´šè¨­å®š
                    </h3>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">é«˜å„ªå…ˆç´šé€šçŸ¥</div>
                            <div class="setting-description">ç·Šæ€¥äº‹ä»¶ç«‹å³é€šçŸ¥</div>
                        </div>
                        <div>
                            <span class="priority-badge priority-critical">Critical</span>
                            <span class="priority-badge priority-high">High</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">ä¸€èˆ¬å„ªå…ˆç´šé€šçŸ¥</div>
                            <div class="setting-description">æ­£å¸¸äº‹ä»¶é€šçŸ¥</div>
                        </div>
                        <div>
                            <span class="priority-badge priority-medium">Medium</span>
                            <span class="priority-badge priority-low">Low</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">åªé¡¯ç¤ºé‡è¦é€šçŸ¥</div>
                            <div class="setting-description">éæ¿¾ä½å„ªå…ˆç´šé€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="importantOnly">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <!-- å®‰éœæ™‚é–“è¨­å®š -->
                <div class="settings-card">
                    <h3 class="card-title">
                        <i class="fas fa-moon"></i>
                        å®‰éœæ™‚é–“
                    </h3>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">å•Ÿç”¨å®‰éœæ™‚é–“</div>
                            <div class="setting-description">æŒ‡å®šæ™‚é–“å…§åœæ­¢é€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="quietHours">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">é–‹å§‹æ™‚é–“</div>
                            <div class="setting-description">å®‰éœæ™‚é–“é–‹å§‹</div>
                        </div>
                        <input type="time" class="setting-input" id="quietHoursStart" value="23:00">
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">çµæŸæ™‚é–“</div>
                            <div class="setting-description">å®‰éœæ™‚é–“çµæŸ</div>
                        </div>
                        <input type="time" class="setting-input" id="quietHoursEnd" value="07:00">
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">ç·Šæ€¥é€šçŸ¥ä¾‹å¤–</div>
                            <div class="setting-description">å®‰éœæ™‚é–“ä»é¡¯ç¤ºç·Šæ€¥é€šçŸ¥</div>
                        </div>
                        <div class="toggle-switch" id="emergencyOverride">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <!-- æ¸¬è©¦èˆ‡è¨ºæ–· -->
                <div class="settings-card">
                    <h3 class="card-title">
                        <i class="fas fa-flask"></i>
                        æ¸¬è©¦èˆ‡è¨ºæ–·
                    </h3>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ¸¬è©¦æ¡Œé¢é€šçŸ¥</div>
                            <div class="setting-description">ç™¼é€æ¸¬è©¦é€šçŸ¥</div>
                        </div>
                        <button class="test-button" id="testDesktop">
                            <i class="fas fa-play"></i> æ¸¬è©¦
                        </button>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ¸¬è©¦è²éŸ³é€šçŸ¥</div>
                            <div class="setting-description">æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆ</div>
                        </div>
                        <button class="test-button" id="testSound">
                            <i class="fas fa-volume-up"></i> æ¸¬è©¦
                        </button>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ¸¬è©¦æ‰€æœ‰é€šé“</div>
                            <div class="setting-description">å…¨é¢æ¸¬è©¦é€šçŸ¥åŠŸèƒ½</div>
                        </div>
                        <button class="test-button" id="testAll">
                            <i class="fas fa-rocket"></i> æ¸¬è©¦å…¨éƒ¨
                        </button>
                    </div>

                    <div class="setting-item">
                        <div>
                            <div class="setting-label">æ¸…é™¤é€šçŸ¥æ­·å²</div>
                            <div class="setting-description">åˆªé™¤æ‰€æœ‰é€šçŸ¥è¨˜éŒ„</div>
                        </div>
                        <button class="test-button" id="clearHistory" style="background: linear-gradient(45deg, #ff4757, #ff3838);">
                            <i class="fas fa-trash"></i> æ¸…é™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-secondary" id="resetSettings">
                    <i class="fas fa-undo"></i>
                    é‡ç½®é è¨­å€¼
                </button>
                <button type="button" class="btn btn-primary" id="saveSettings">
                    <i class="fas fa-save"></i>
                    å„²å­˜è¨­å®š
                </button>
                <a href="/advanced-dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    è¿”å›å„€è¡¨æ¿
                </a>
            </div>
        </div>
    </div>

    <!-- Notification Container for Settings Page -->
    <div class="notification-container" id="settingsNotificationContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/smart-notifications.js"></script>
    
    <script>
        // æ™ºèƒ½é€šçŸ¥ç³»çµ±è¨­å®šç®¡ç†
        let notificationSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // ç­‰å¾…é€šçŸ¥ç³»çµ±åˆå§‹åŒ–
            await waitForNotificationSystem();
            
            await initializeSettings();
            setupEventListeners();
            await loadStatistics();
            
            console.log('ğŸ“‹ Notification settings page initialized');
        });

        async function waitForNotificationSystem() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkSystem = () => {
                    attempts++;
                    console.log(`ğŸ”” æª¢æŸ¥é€šçŸ¥ç³»çµ± (å˜—è©¦ ${attempts}/${maxAttempts})`);
                    
                    if (window.smartNotifications) {
                        notificationSystem = window.smartNotifications;
                        console.log('âœ… ä½¿ç”¨ç¾æœ‰é€šçŸ¥ç³»çµ±å¯¦ä¾‹');
                        resolve();
                    } else if (window.SmartNotificationSystem) {
                        // å¦‚æœé¡å¯ç”¨ä½†å¯¦ä¾‹ä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°å¯¦ä¾‹
                        try {
                            notificationSystem = new SmartNotificationSystem();
                            console.log('ğŸ”§ å‰µå»ºæ–°çš„é€šçŸ¥ç³»çµ±å¯¦ä¾‹');
                            // çµ¦æ–°å¯¦ä¾‹ä¸€äº›æ™‚é–“åˆå§‹åŒ–
                            setTimeout(resolve, 2000);
                        } catch (error) {
                            console.error('å‰µå»ºé€šçŸ¥ç³»çµ±å¯¦ä¾‹å¤±æ•—:', error);
                            if (attempts < maxAttempts) {
                                setTimeout(checkSystem, 100);
                            } else {
                                reject(new Error('ç„¡æ³•å‰µå»ºé€šçŸ¥ç³»çµ±å¯¦ä¾‹'));
                            }
                        }
                    } else if (attempts < maxAttempts) {
                        // å¦‚æœé¡é‚„æ²’è¼‰å…¥ï¼Œç­‰å¾…ä¸€ä¸‹å†æª¢æŸ¥
                        setTimeout(checkSystem, 100);
                    } else {
                        reject(new Error('ç„¡æ³•è¼‰å…¥é€šçŸ¥ç³»çµ±'));
                    }
                };
                checkSystem();
            });
        }

        async function initializeSettings() {
            try {
                await loadSettings();
                setupToggleSwitches();
                setupInputFields();
            } catch (error) {
                console.error('Failed to initialize settings:', error);
                notificationSystem.error('è¨­å®šè¼‰å…¥å¤±æ•—', 'ç„¡æ³•è¼‰å…¥é€šçŸ¥è¨­å®šï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        async function loadSettings() {
            try {
                // å˜—è©¦å¾ API åŠ è¼‰è¨­å®š
                const response = await fetch('/api/notifications/settings', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                    }
                });

                if (response.ok) {
                    const serverResponse = await response.json();
                    if (serverResponse.success && serverResponse.data) {
                        // è½‰æ› API éŸ¿æ‡‰æ ¼å¼ç‚ºå…§éƒ¨æ ¼å¼
                        const serverSettings = {
                            channels: {
                                desktop: serverResponse.data.desktopNotifications,
                                sound: serverResponse.data.soundNotifications,
                                vibration: serverResponse.data.vibrationNotifications,
                                email: serverResponse.data.emailNotifications,
                                line: serverResponse.data.lineNotifications
                            },
                            settings: {
                                maxNotifications: serverResponse.data.maxNotifications,
                                autoExpiry: serverResponse.data.displayDuration * 1000, // è½‰æ›ç‚ºæ¯«ç§’
                                groupSimilar: serverResponse.data.batchNotifications,
                                quietHours: {
                                    enabled: serverResponse.data.quietHours,
                                    start: serverResponse.data.quietStart,
                                    end: serverResponse.data.quietEnd
                                },
                                importantOnly: serverResponse.data.importantOnly,
                                position: serverResponse.data.notificationPosition
                            }
                        };
                        updateUIFromSettings(serverSettings);
                        console.log('âœ… Settings loaded from server');
                    } else {
                        throw new Error('Invalid server response');
                    }
                } else {
                    throw new Error('Failed to load from server');
                }
            } catch (error) {
                console.warn('Loading settings from API failed, using default settings:', error);
                updateUIFromSettings({
                    channels: notificationSystem.channels,
                    settings: notificationSystem.settings
                });
            }
        }

        async function loadStatistics() {
            try {
                const stats = await notificationSystem.getStatistics();
                updateStatisticsDisplay(stats);
            } catch (error) {
                console.warn('Failed to load statistics:', error);
                // ä½¿ç”¨é»˜èªçµ±è¨ˆæ•¸æ“š
                const defaultStats = {
                    totalNotifications: 256,
                    todayNotifications: 18,
                    readNotifications: 242,
                    averageResponseTime: 138 // ç§’
                };
                updateStatisticsDisplay(defaultStats);
            }
        }

        function updateStatisticsDisplay(stats) {
            document.getElementById('totalNotifications').textContent = stats.totalNotifications || 0;
            document.getElementById('todayNotifications').textContent = stats.todayNotifications || 0;
            document.getElementById('readNotifications').textContent = stats.readNotifications || 0;
            document.getElementById('avgResponseTime').textContent = 
                stats.averageResponseTime ? (stats.averageResponseTime / 60).toFixed(1) : '0';
        }

        function updateUIFromSettings(settings) {
            const { channels, settings: notificationSettings } = settings;
            
            // æ›´æ–°é€šé“é–‹é—œ
            updateToggleSwitch('desktopNotifications', channels.desktop);
            updateToggleSwitch('soundNotifications', channels.sound);
            updateToggleSwitch('vibrationNotifications', channels.vibration);
            updateToggleSwitch('emailNotifications', channels.email);
            updateToggleSwitch('lineNotifications', channels.line);
            
            // æ›´æ–°åå¥½è¨­å®š
            updateToggleSwitch('batchNotifications', notificationSettings.groupSimilar);
            updateToggleSwitch('smartGrouping', notificationSettings.groupSimilar);
            updateToggleSwitch('importantOnly', notificationSettings.importantOnly || false);
            updateToggleSwitch('quietHours', notificationSettings.quietHours?.enabled || false);
            updateToggleSwitch('emergencyOverride', notificationSettings.emergencyOverride || false);
            
            // æ›´æ–°è¼¸å…¥å­—æ®µ
            if (document.getElementById('displayDuration')) {
                document.getElementById('displayDuration').value = Math.floor(notificationSettings.autoExpiry / 1000);
            }
            if (document.getElementById('maxNotifications')) {
                document.getElementById('maxNotifications').value = notificationSettings.maxNotifications;
            }
            if (document.getElementById('quietHoursStart')) {
                document.getElementById('quietHoursStart').value = notificationSettings.quietHours?.start || '22:00';
            }
            if (document.getElementById('quietHoursEnd')) {
                document.getElementById('quietHoursEnd').value = notificationSettings.quietHours?.end || '08:00';
            }
            if (document.getElementById('notificationPosition')) {
                document.getElementById('notificationPosition').value = notificationSettings.position || 'top-right';
            }
        }

        function updateToggleSwitch(id, isActive) {
            const toggle = document.getElementById(id);
            if (toggle) {
                toggle.classList.toggle('active', isActive);
            }
        }

        function setupToggleSwitches() {
            const toggles = document.querySelectorAll('.toggle-switch');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', handleToggleSwitch);
            });
        }

        function setupInputFields() {
            // é¡¯ç¤ºæ™‚é–“è¨­å®š
            document.getElementById('displayDuration').addEventListener('change', async (e) => {
                const value = parseInt(e.target.value) * 1000;
                await updateSetting('autoExpiry', value);
                showSettingUpdateNotification('displayDuration', e.target.value + ' ç§’');
            });

            // æœ€å¤§é€šçŸ¥æ•¸è¨­å®š
            document.getElementById('maxNotifications').addEventListener('change', async (e) => {
                const value = parseInt(e.target.value);
                await updateSetting('maxNotifications', value);
                showSettingUpdateNotification('maxNotifications', e.target.value);
            });

            // å®‰éœæ™‚é–“è¨­å®š
            document.getElementById('quietHoursStart').addEventListener('change', async (e) => {
                await updateQuietHours();
            });

            document.getElementById('quietHoursEnd').addEventListener('change', async (e) => {
                await updateQuietHours();
            });
        }

        async function handleToggleSwitch(event) {
            const toggle = event.currentTarget;
            const isActive = toggle.classList.contains('active');
            const newState = !isActive;
            
            toggle.classList.toggle('active', newState);
            
            const id = toggle.id;
            try {
                switch (id) {
                    case 'desktopNotifications':
                        await updateChannel('desktop', newState);
                        break;
                    case 'soundNotifications':
                        await updateChannel('sound', newState);
                        break;
                    case 'vibrationNotifications':
                        await updateChannel('vibration', newState);
                        break;
                    case 'emailNotifications':
                        await updateChannel('email', newState);
                        break;
                    case 'lineNotifications':
                        await updateChannel('line', newState);
                        break;
                    case 'batchNotifications':
                        await updateSetting('groupSimilar', newState);
                        break;
                    case 'smartGrouping':
                        await updateSetting('groupSimilar', newState);
                        break;
                    case 'importantOnly':
                        await updateSetting('importantOnly', newState);
                        break;
                    case 'quietHours':
                        await updateQuietHours(newState);
                        break;
                    case 'emergencyOverride':
                        await updateSetting('emergencyOverride', newState);
                        break;
                }
                
                showSettingUpdateNotification(id, newState);
            } catch (error) {
                console.error('Failed to update setting:', error);
                // å›å¾©åˆ‡æ›ç‹€æ…‹
                toggle.classList.toggle('active', !newState);
                notificationSystem.error('è¨­å®šæ›´æ–°å¤±æ•—', 'ç„¡æ³•ä¿å­˜è¨­å®šæ›´æ”¹');
            }
        }

        async function updateChannel(channel, state) {
            const newChannels = { ...notificationSystem.channels, [channel]: state };
            await notificationSystem.updateSettings({ channels: newChannels });
        }

        async function updateSetting(key, value) {
            const newSettings = { ...notificationSystem.settings, [key]: value };
            await notificationSystem.updateSettings({ settings: newSettings });
        }

        async function updateQuietHours(enabled = null) {
            const quietHoursEnabled = enabled !== null ? enabled : 
                document.getElementById('quietHours').classList.contains('active');
            const start = document.getElementById('quietHoursStart').value;
            const end = document.getElementById('quietHoursEnd').value;
            
            const quietHours = {
                enabled: quietHoursEnabled,
                start: start,
                end: end
            };
            
            const newSettings = { 
                ...notificationSystem.settings, 
                quietHours: quietHours 
            };
            await notificationSystem.updateSettings({ settings: newSettings });
        }

        function setupEventListeners() {
            // æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶
            document.getElementById('testDesktop')?.addEventListener('click', testDesktopNotification);
            document.getElementById('testSound')?.addEventListener('click', testSoundNotification);
            document.getElementById('testAll')?.addEventListener('click', testAllChannels);
            
            // æ“ä½œæŒ‰éˆ•äº‹ä»¶
            document.getElementById('saveSettings')?.addEventListener('click', saveSettings);
            document.getElementById('resetSettings')?.addEventListener('click', resetToDefaults);
            document.getElementById('clearHistory')?.addEventListener('click', clearNotificationHistory);
        }

        async function saveSettings() {
            try {
                // è¨­å®šå·²ç¶“åœ¨æ›´æ”¹æ™‚è‡ªå‹•ä¿å­˜ï¼Œé€™è£¡åªéœ€è¦é¡¯ç¤ºç¢ºèª
                notificationSystem.success('è¨­å®šå·²ä¿å­˜', 'æ‚¨çš„é€šçŸ¥åå¥½å·²æˆåŠŸä¿å­˜');
                
                // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                await loadStatistics();
            } catch (error) {
                console.error('Failed to save settings:', error);
                notificationSystem.error('ä¿å­˜å¤±æ•—', 'ç„¡æ³•ä¿å­˜è¨­å®šï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function resetToDefaults() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šç‚ºé è¨­å€¼å—ï¼Ÿ')) {
                try {
                    const defaultSettings = {
                        channels: {
                            desktop: true,
                            sound: true,
                            vibration: true,
                            email: false,
                            line: false
                        },
                        settings: {
                            maxNotifications: 50,
                            autoExpiry: 30000,
                            groupSimilar: true,
                            quietHours: {
                                enabled: false,
                                start: '22:00',
                                end: '08:00'
                            },
                            importantOnly: false
                        }
                    };
                    
                    await notificationSystem.updateSettings(defaultSettings);
                    updateUIFromSettings(defaultSettings);
                    
                    notificationSystem.success('è¨­å®šå·²é‡ç½®', 'æ‰€æœ‰è¨­å®šå·²é‡ç½®ç‚ºé è¨­å€¼');
                } catch (error) {
                    console.error('Failed to reset settings:', error);
                    notificationSystem.error('é‡ç½®å¤±æ•—', 'ç„¡æ³•é‡ç½®è¨­å®š');
                }
            }
        }

        async function testDesktopNotification() {
            try {
                await notificationSystem.sendTestNotification('desktop');
            } catch (error) {
                console.error('Desktop test failed:', error);
            }
        }

        async function testSoundNotification() {
            try {
                await notificationSystem.sendTestNotification('sound');
            } catch (error) {
                console.error('Sound test failed:', error);
            }
        }

        async function testAllChannels() {
            try {
                const enabledChannels = Object.keys(notificationSystem.channels)
                    .filter(channel => notificationSystem.channels[channel]);
                
                for (const channel of enabledChannels) {
                    await notificationSystem.sendTestNotification(channel);
                    await new Promise(resolve => setTimeout(resolve, 500)); // å»¶é² 500ms
                }
                
                notificationSystem.success('æ¸¬è©¦å®Œæˆ', `å·²æ¸¬è©¦ ${enabledChannels.length} å€‹å•Ÿç”¨çš„é€šçŸ¥é€šé“`);
            } catch (error) {
                console.error('All channels test failed:', error);
            }
        }

        async function clearNotificationHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é€šçŸ¥æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                try {
                    await fetch('/api/notifications/history', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                        }
                    });
                    
                    notificationSystem.clearAll();
                    await loadStatistics();
                    
                    notificationSystem.success('æ­·å²å·²æ¸…é™¤', 'æ‰€æœ‰é€šçŸ¥æ­·å²è¨˜éŒ„å·²è¢«æ¸…é™¤');
                } catch (error) {
                    console.error('Failed to clear history:', error);
                    notificationSystem.error('æ¸…é™¤å¤±æ•—', 'ç„¡æ³•æ¸…é™¤é€šçŸ¥æ­·å²è¨˜éŒ„');
                }
            }
        }

        function showSettingUpdateNotification(key, value) {
            const friendlyNames = {
                'desktopNotifications': 'æ¡Œé¢é€šçŸ¥',
                'soundNotifications': 'è²éŸ³æé†’',
                'vibrationNotifications': 'éœ‡å‹•æé†’',
                'emailNotifications': 'éƒµä»¶é€šçŸ¥',
                'lineNotifications': 'LINE é€šçŸ¥',
                'displayDuration': 'é¡¯ç¤ºæ™‚é–“',
                'maxNotifications': 'æœ€å¤§é€šçŸ¥æ•¸',
                'quietHours': 'å®‰éœæ™‚é–“',
                'importantOnly': 'åƒ…é‡è¦é€šçŸ¥'
            };
            
            const settingName = friendlyNames[key] || key;
            const statusText = typeof value === 'boolean' ? (value ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨') : `å·²è¨­ç‚º ${value}`;
            
            notificationSystem.info('è¨­å®šå·²æ›´æ–°', `${settingName} ${statusText}`, {
                priority: 'low',
                duration: 2000
            });
        }

        // PWA Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/js/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
